let users = [];

/**
 * Loads users from local storage into the users array.
 */
async function loadUsers() {
    try {
        users = JSON.parse(localStorage.getItem('users')) || [];
    } catch (e) {
        console.error('Could not load users', e);
    }
}

/**
 * Logs in the user as a guest and redirects to the summary page.
 */
function guestLogin() {
    localStorage.setItem('currentUser', 'guest');
    window.location.href = 'summary.html';
}

/**
 * Initializes the signup page.
 */
function initSignup() {
    // Clean Code: No dummy data in production
}

/**
 * Toggles the signup button state based on form validity.
 */
function toggleSignupBtn() {
    const canSignup = checkSignupValidity();
    document.getElementById('signupBtn').disabled = !canSignup;
}

/**
 * Checks if all signup requirements are met.
 * @returns {boolean} True if valid, false otherwise.
 */
function checkSignupValidity() {
    const privacyCheckbox = document.getElementById('privacyPolicy');
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    return privacyCheckbox.checked && password.length > 0 && password === confirmPassword;
}

/**
 * Validates if the password and confirm password fields match.
 * Updates the UI accordingly.
 */
function validatePassword() {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const msgBox = document.getElementById('msgBox');
    const confirmInput = document.getElementById('confirmPassword');

    if (password !== confirmPassword && confirmPassword.length > 0) {
        showPasswordError(msgBox, confirmInput);
    } else {
        hidePasswordError(msgBox, confirmInput);
    }
    toggleSignupBtn();
}

/**
 * Shows the password mismatch error.
 * @param {HTMLElement} msgBox - The error message element.
 * @param {HTMLElement} input - The input element to style.
 */
function showPasswordError(msgBox, input) {
    msgBox.classList.remove('d-none');
    input.style.borderColor = '#FF8190';
}

/**
 * Hides the password mismatch error.
 * @param {HTMLElement} msgBox - The error message element.
 * @param {HTMLElement} input - The input element to style.
 */
function hidePasswordError(msgBox, input) {
    msgBox.classList.add('d-none');
    input.style.borderColor = '#D1D1D1';
}

/**
 * Updates the password input icon based on input content.
 * @param {string} inputId - The ID of the input field.
 */
function updatePasswordIcon(inputId) {
    const input = document.getElementById(inputId);
    const icon = input.nextElementSibling;

    if (input.value.length === 0) {
        icon.src = 'assets/img/lock_icon.png';
        input.type = 'password';
    } else {
        
        if (icon.src.includes('lock_icon.png')) {
            icon.src = 'assets/img/invisible.png';
        }
    }
}

/**
 * Toggles the visibility of the password input.
 * @param {string} inputId - The ID of the input field.
 * @param {HTMLElement} icon - The icon element to update.
 */
function togglePasswordVisibility(inputId, icon) {
    const input = document.getElementById(inputId);
    if (input.value.length === 0) return; 

    const type = input.type === 'password' ? 'text' : 'password';
    input.type = type;
    icon.src = type === 'password' ? 'assets/img/invisible.png' : 'assets/img/visible.png';
}

/**
 * Registers a new user if they don't exist yet.
 */
async function register() {
    const name = document.getElementById('name').value;
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    await loadUsers();
    
    if (isUserExisting(email)) {
        alert('User already exists!');
        return;
    }

    await createAndLoginUser(name, email, password);
}

/**
 * Checks if a user with the given email already exists.
 * @param {string} email - The email to check.
 * @returns {boolean} True if user exists.
 */
function isUserExisting(email) {
    return users.some(u => u.email === email);
}

/**
 * Creates a new user, saves to storage, and logs them in.
 * @param {string} name - User name.
 * @param {string} email - User email.
 * @param {string} password - User password.
 */
async function createAndLoginUser(name, email, password) {
    users.push({ name: name, email: email, password: password });
    await localStorage.setItem('users', JSON.stringify(users));
    loginSuccess(name);
}

/**
 * Handles the login process.
 */
async function login() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    await loadUsers();
    const user = users.find(u => u.email === email && u.password === password);

    if (user) {
        loginSuccess(user.name);
    } else {
        showLoginError();
    }
}

/**
 * Sets the current user and redirects to summary.
 * @param {string} name - The user's name.
 */
function loginSuccess(name) {
    localStorage.setItem('currentUser', name);
    window.location.href = 'summary.html';
}

/**
 * Displays the login error message.
 */
function showLoginError() {
    const msgBox = document.getElementById('msgBox');
    if (msgBox) msgBox.classList.remove('d-none');
}